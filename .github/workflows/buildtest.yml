# test.yml

name: 'Build Test Before Merge'

# workflow ë¥¼ ë™ì‘í•˜ê¸° ìœ„í•œ Trigger ë‚´ìš©ì…ë‹ˆë‹¤.
# main Branch ì— ëŒ€í•œ PR ì´ Open í˜¹ì€ Sync ë ë•Œ ì•„ë˜ì˜ Job ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
on:
  pull_request:
    types:
      - opened 
      - synchronize 
    branches:
      - main 

# jobs ì€ step ìœ¼ë¡œ êµ¬ì„±í•  ìˆ˜ ìˆê³ , ì´ëŸ¬í•œ step ì„ ë³‘ë ¬ë¡œ ë‚˜ëˆ„ì–´ì„œ ì‹¤í–‰ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
# ì—¬ëŸ¬ê°œì˜ job ì„ ì„¤ì •í•˜ì—¬ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë©°, job ê°„ì— ì •ë³´êµí™˜ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.

jobs:
  test:
    # job ì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤.
    name: Build Test
    # ë¦¬ëˆ…ìŠ¤ í™˜ê²½ì—ì„œ ì‚¬ìš©í•œë‹¤ê³  ëª…ì‹œí•©ë‹ˆë‹¤.
    runs-on: ubuntu-latest
    # Github Action ì˜ ì‹¤í–‰ì „ëµì„ ìƒˆì›ë‹ˆë‹¤.
    # Node Version ì„ ì„¤ì¹˜í• ë•Œ 18 ë²„ì „ì„ ì‚¬ìš©í•˜ë„ë¡ í•©ë‹ˆë‹¤.
    strategy:
      matrix:
        node-versions: [18.x]
    # job ì˜ step ì„ ì •ì˜í•©ë‹ˆë‹¤.
    steps:
      # Action ì¤€ë¹„
      - uses: act10ns/slack@v2
        with:
          status: starting
          webhook-url: ${{ secrets.SLACK_INCOMING_URL }}
          message: "ğŸ“£ Opened Pull Request & Build Test Start\n<${{ github.event.pull_request.html_url }}|ğŸš€ View Pull Request>"
        if: always()

      # ì´ì œ ì‹œì‘ì— ì•ì„œì„œ Github Actions ì—ì„œ ìš°ë¦¬ëŠ” Linux í™˜ê²½ìœ¼ë¡œ Checkout í•˜ì—¬ ì‹¤í–‰í•˜ê²Œë©ë‹ˆë‹¤.
      - name: Checkout
        uses: actions/checkout@v3

      # ìœ„ ì—ì„œ ëª…ì‹œí•œ node-version ì„ í™œìš©í•˜ì—¬ Node.js ë¥¼ ì„¤ì¹˜ í›„ ê·¸ ìœ„ì—ì„œ ì§„í–‰í•œë‹¤ê³  ëª…ì‹œí•©ë‹ˆë‹¤.
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - uses: pnpm/action-setup@v2
        name: Install pnpm
        with:
          version: 8
          run_install: false

      
      # pnpm-store ì˜ ìœ„ì¹˜ë¥¼ ì°¾ì•„ $GITHUB_ENV ì— ì €ì¥í•©ë‹ˆë‹¤.
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # pnpm-store ë¥¼ ìºì‹±í•˜ì—¬ ì´ë¯¸ ë‹¤ìš´ë¡œë“œëœ ì¢…ì†ì„±ì´ ë¡œì»¬ì— ì €ì¥ë˜ë¯€ë¡œ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      # node_module ê³¼ next Cache ë¥¼ caching í•˜ì—¬ ì‹œê°„ì„ ë‹¨ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      - uses: actions/cache@v3
        name: Setup pnpm & next Build cache
        id: cache
        with:
          path: |
            node_modules
            ${{ github.workspace }}/.next/cache
          key: cache-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            cache-

      - name: Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: pnpm install

      # Lint Test ì§„í–‰ í•©ë‹ˆë‹¤.
      # if ë¬¸ì— always() ë¥¼ ì¶”ê°€í•˜ë©´ ì´ì „ì— ì‹¤íŒ¨í•œ ë¶€ë¶„ì´ ìƒê¸°ë”ë¼ë„ ë¬´ì¡°ê±´ ì‹¤í–‰í•˜ê²Œ ë©ë‹ˆë‹¤.
      - name: Lint Test
        id: Lint-Test
        run: pnpm lint
        if: ${{ always() }}

      # Type Check Test ì§„í–‰ í•©ë‹ˆë‹¤.
      - name: Type Check
        id: Type-Check
        run: pnpm typecheck
        if: ${{ always() }}

      # Build Test ì§„í–‰ í•©ë‹ˆë‹¤.
      - name: Build Test
        id: Build-Test
        run: |
          pnpm build
        if: ${{ always() }}

      - uses: act10ns/slack@v2
        with:
          status: ${{ job.status }}
          steps: ${{ toJson(steps) }}
          channel: '#workflows'
          webhook-url: ${{ secrets.SLACK_INCOMING_URL }}
          config: .github/config/slack.yml
        if: always()
